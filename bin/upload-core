#!/bin/bash -e

die() {
    echo "$@" >&2
    exit 1
}

[ -z "${CORE_BUCKET}" ] && die "CORE_BUCKET not set"

for CORE; do
	echo "Saving ${CORE} to S3 as latest core."

  # in case the MOO dumps while we're processing this core, make a copy and work
  # from that. 
 	TEMP_CORE=$(mktemp)
	trap 'rm -f "${TEMP_CORE}*"' EXIT
	cp "${CORE}" "${TEMP_CORE}"

	HASH=$(shasum -a 256 "${TEMP_CORE}" | cut -c -64 | tee "${TEMP_CORE}.hash")
	URL="${CORE_BUCKET}/core-${HASH}.db"

	# Assume prior uploads have succeeded if a content-identical core already
	# exists
	if ! bin/s3 head "${URL}"; then
		bin/s3 put "${URL}" "${TEMP_CORE}"
	fi
	bin/s3 put "${CORE_BUCKET}/latest.hash" "${TEMP_CORE}.hash"

	rm -f "${TEMP_CORE}*"
	trap EXIT

	echo "Saved ${CORE} to S3."
done
