#!/bin/bash -e

if bin/download-core database/restore.db; then
	echo "Restored core from S3."
	CORE=database/restore.db
else
	echo "Bootstrapping with new core."
	CORE=database/bootstrap.db
fi

trap 'bin/upload-core database/snapshot.db' EXIT

# HACK HACK HACK - Heroku sends SIGTERM to the whole process group, which screws
# up the timing of the final database upload. Terminating this script causes the
# upload to start immediately, even if the MOO server is still shutting down.
#
# Suppressing the signal here (well, propagating it to the server process)
# instead allows the cleanup to happen after the MOO has shut down.
server/moo "${CORE}" database/snapshot.db -p "${MOO_PORT}" &
trap "kill -TERM $!; wait" TERM
wait
